---
title: "Cocktail Installation on Azure"
excerpt: ""
permalink: /docs/ja/8.2.3/
redirect_from:
  - /theme-setup/
toc: true
toc_sticky: false
sidebar:
  nav: "ja"
---

### **事前準備**

インストール前に、インスタンスの準備及び以下のプログラムを予めインストールする必要があります。インストールされていない場合はエラーメッセージが表示されます。

1\) 提供された cube バイナリをどのディレクトリでも利用できるように、環境変数 path の設定をする。

2\) Docker ダウンロード後、インストール : [Get Docker CE for CentOS](https://docs.docker.com/install/linux/docker-ce/centos/)

3\) Azure Files Service を準備する必要があります。

4\) Azure Active Directory も同様に準備する必要があります。

-----

### **インストール**

**1. インストールのために空のディレクトリを作成後、そのディレクトリに移動する。**

```
# mkdir /Desktop/cube
# cd /Desktop/cube
```

**2. cube コマンドの -p Flag を使用して、各 Provider のインストール script を download して初期化する。**

| Provider list |
| ------------- |
| onpremise |
| aws |
| **azure** |
| gcp |
| aliyun |
| aks |
| eks |
| gke |

```
# cube init -p azure
```

**3. cube.toml ファイルをエディタで開いて Provider 情報およびインスタンス情報を記入する。**

-----

### Provider 別 cube.toml 作成方法

#### AWS cube.toml の作成

| <U>[cube]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| version | cube version (kubernetes version 毎に対応する cube version が異なる) | version = "1.13.5-r5" |
| provider | provider 使用設定 | provider = true |
| cluster-name | Cluster Name の付与 | cluster-name = "test-cluster" |
| cluster-description | Cluster Description | cluster-description = "This is test cluster" |
| cluster-type | クラスタの使用規模とHA構成可否によって、タイプを区別 **[large/medium/Small/tiny/kaas]** [Learn more](../8.1.2.9) | cluster-type = "small" |
| cluster-id | Cluster 固有 ID (Cocktail 画面から cluster 登録の際に使用される。) | cluster-id = "test-cluster-id" |
| alert-language | alert message 言語設定 | alert-language = "ko" |

<br/>

| <U>[kubenetes]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| service-cidr | kubernetes service ネットワーク領域 | service-cidr = "10.96.0.0/12" |
| pod-cidr | kubernetes pod ネットワーク領域 | pod-cidr="10.32.0.0/12" |
| api-sans | SAN(Subject Alternative Name) 認証書使用時、サブリスト作成 | api-sans = [] |


<br/>

| <U>[kubenetes.etcd]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ip | etcd インストールノード Internal IP (奇数インスタンス) | ip = "Your Primary internal IP" |

※ **etcd** は key-value storage で、すべての object(pod, rc, service, secret など)を分散保存する。  
api server で間接的に Read/Write されるが、この時、簡易的なロック方式により同時性制御をコントロールし、優先順位は [RAFT アルゴリズム](https://raft.github.io/) を活用する。  
そのため、etcd インスタンスは奇数にしなければならない。  
最適なクラスターサイズの詳細内容は [CoreOS ドキュメントを参考にする](https://coreos.com/etcd/docs/latest/v2/admin_guide.html#optimal-cluster-size)

<br/>

| <U>[node-pool]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| data-dir | data 使用ディレクトリを指定 | data-dir = "/data" |

<br/>

| <U>[node-pool.provider]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| name | Node Pool Provider Name | name = "azure" |
| location | Node Region Zone Name | location = "koreacentral" |
| virtual-network-name | Azure virtual network | virtual-network-name = "cocktail-vnet" |
| subnet-name | Azure subnet network | subnet-name = "cocktail-subnet" |
| security-group-name | Azure Security Group | security-group-name = "worker-nsg" |
| primary-availablity-set-name | Azure Availablity Set | primary-availablity-set-name = "master-avs" |
| resource-group | Azure Resource Group | resource-group = "azure-8s-v2" |
| route-table-name ="master-rt" | Azure Route Table | route-table-name ="master-rt" |

<br/>

| <U>[node-pool.security]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ssh-user-id | SSH User ID | ssh-user-id = "test" |
| private-key-path | Private key path | private-key-path = "/root/cubetest/cert/id_rsa" |
| key-path | Public key path | key-path = "/root/cubetest/cert/id_rsa.pub" |

<br/>

| <U>[node-pool.master]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ip | Master Node インストール IP | ip = "Your master IP" |
| internal-lb | Loadbalancer IP | ip = "Your internal lb IP" |
| external-lb | Loadbalancer IP | ip = "Your external lb IP" |
| node-port-url | node-port-url IP | ip = "Your node port url IP" |
| node-portrange | Node Portrange(30000-32767) | node-portrange = "30000-32767" |
| haproxy-install | Haproxy をインストールするかどうか | haproxy-install = false |
| non-isolated | master node 領域に pod を生成するかどうか | non-isolated = false |

<br/>

| <U>[[node-pool.nodes]]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ip | Worker Node インストール IP | ip = "Your Worker node IP" |

<br/>

| <U>[[enterprise-product]]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| install | enterprise(cocktail-system) インストール可否をチェック | install = true |
| release-name | enterprise(リリース名-system) namespace をリリース名で使用 | release-name = "cocktail" |
| version | enterprise(cocktail-system) のインストール version | version="3.3.0" |
| https | https を使用するかどうか | https = false |

<br/>

| <U>[[enterprise-product.cert-file]]</U> : 上記 https = true の場合に適用|
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ssl-certificate | ssl 証明書 path | ssl-certificate = "test.crt" |
| release-name | ssl 証明書 key path | ssl-certificate-key = "test.key" |


<br/>

| <U>[[addon]]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| install | cocktail addon(cocktail-addon) をインストールするかどうか | install = true |

<br/>

| <U>[shared-storage]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| storage-account | Azure Storage accounts name | storage-account = "azurecocktail" |

<br/>

| <U>[private-registry]</U> |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| install | registry(harbor) をインストールするかどうか | install = true |
| registry-ip | registry IP : harbor インストール | ip = "Your registry IP" |
| data-dir | Registry data directory path | data-dir = "/data" |
| public-cert | 認証を使用するかどうか | public-cert = false |

<br/>

| <U>[private-registry.cert-file]</U> : 上記 public-cert=true の場合に適用 |
| 項目 | 説明 | 例 |
| ---- | ---- | ---- |
| ssl-certificate | ssl 証明書 path | ssl-certificate = "test.crt" |
| release-name | ssl 証明書 key path | ssl-certificate-key = "test.key" |


#### 使用例
* cube init コマンドで初期 cube.toml ファイルを生成後、Provider 情報及びインスタンス情報を記入する。

```
# cube init -p azure
```

```
[cube]
version = "1.13.5-r5"
provider = true
cluster-name = "test-cluster"
cluster-description = "This is test cluster"
cluster-type = "small"
cluster-id = "test-cluster-id"
alert-language = "ko"


[kubenetes]
service-cidr = "10.96.0.0/12"
pod-cidr = "10.10.0.0/16"
api-sans = []


  [kubenetes.etcd]
  ip = ["192.168.x.x"]

[node-pool]
data-dir = "/data"

  [node-pool.provider]
  name = "azure"
  location = "koreacentral"
  virtual-network-name = "cocktail-vnet"
  subnet-name = "cocktail-subnet"
  security-group-name = "worker-nsg"
  primary-availablity-set-name = "master-avs"
  resource-group = "azure-8s-v2"
  route-table-name ="master-rt"

  [node-pool.security]
  ssh-user-id = "root"
  private-key-path = "id_rsa.pub"
  key-path = "id_rsa"

  [node-pool.master]
  ip = ["192.168.x.x"]
  internal-lb = "192.168.x.x"
  external-lb = "101.x.x.x"
  node-port-url = "192.168.x.x"
  node-portrange = "30000-32767"
  haproxy-install = false
  non-isolated = false

  [[node-pool.nodes]]
  ip = ["192.168.x.x","192.168.x.x"]

[enterprise-product]
install = true
release-name = "cocktail"
version = "3.3.0"
https = false
  [enterprise-product.cert-file]
  ssl-certificate = ""
  ssl-certificate-key = ""

[addon]
install = true

[shared-storage]
storage-account = "azurecocktail"

[private-registry]
install = true
registry-ip = "192.168.x.x"
data-dir = "/data"
public-cert = false
  [private-registry.cert-file]
  ssl-certificate = ""
  ssl-certificate-key = ""
```

------
<br/>

**※ ssh key で接続する**  
上記の項目で private_key_path と key\_path は、サーバーに ssh key で接続するための private key と public key のパスを記入する。  
既に存在している場合は、そのパスを記入すればよい。
新規に作成する場合には、以下の手順で生成する。

&lt; ssh key 新規発行方法 &gt;

```
# ssh-keygen -f /path/to/private_file -t rsa -N ''
```

**4. cube create コマンドを使用して、Cocktail Cluster をインストールする。**

```
# cube create
```

**5. エラー無くインストールが完了したら、system を構成するコンテナが正常起動しているかどうか、以下コマンドで確認する。**

```
# cube status
```

**6. ブラウザで [http://lb:30000](http://lb:30000) に接続すると login 画面にアクセスすることができる。(初期接続アカウント: admin/Pass0000)**